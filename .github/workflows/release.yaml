name: Release module
on:
  workflow_dispatch:

jobs:
  publish:
    name: Run build
    runs-on: windows-latest
    permissions:
      contents: write  # Required for creating releases
    steps:
    - name: Fail if branch is not main
      if: github.event_name == 'workflow_dispatch' && github.ref != 'refs/heads/main'
      run: |
        echo "This workflow should not be triggered with workflow_dispatch on a branch other than main"
        exit 1

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0
      with:
        versionSpec: '5.x'

    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v0
      with:
        useConfigFile: true    
    - name: publish
      shell: pwsh
      env:
        PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
      run: $env:PSGALLERY_API_KEY ; ./build.ps1 -Task Release -Bootstrap

    - name: Zip built module
      shell: pwsh
      run: |
        $moduleName = "OctopusDeploy"
        $version = "${{ steps.gitversion.outputs.semVer }}"
        $outputPath = ".\Output\$moduleName"
        $zipFileName = "${moduleName}-${version}.zip"
        
        if (Test-Path $outputPath) {
          Write-Host "Creating zip file: $zipFileName"
          Compress-Archive -Path "$outputPath\*" -DestinationPath ".\$zipFileName" -Force
          Write-Host "Zip file created successfully"
          
          # Verify zip was created
          if (Test-Path ".\$zipFileName") {
            $zipSize = (Get-Item ".\$zipFileName").Length
            Write-Host "Zip file size: $($zipSize / 1MB) MB"
          }
        } else {
          Write-Error "Output path not found: $outputPath"
          exit 1
        }
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.gitversion.outputs.semVer }}
        name: Release v${{ steps.gitversion.outputs.semVer }}
        body: |
          ## OctopusDeploy Module Release v${{ steps.gitversion.outputs.semVer }}
          
          ### Installation
          Download the zip file and extract it to your PowerShell modules directory, or install from PowerShell Gallery:
          ```powershell
          Install-Module -Name OctopusDeploy
          ```
          
          ### Changes
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
        files: |
          OctopusDeploy-${{ steps.gitversion.outputs.semVer }}.zip
        draft: false
        prerelease: false  # For mainline/main branch, never mark as prerelease
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}