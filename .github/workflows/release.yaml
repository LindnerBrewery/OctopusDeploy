name: Release module
on:
  workflow_dispatch:

jobs:
  publish:
    name: Run build
    runs-on: windows-latest
    permissions:
      contents: write  # Required for creating releases
    steps:
    - name: Fail if branch is not main
      if: github.event_name == 'workflow_dispatch' && github.ref != 'refs/heads/main'
      run: |
        echo "This workflow should not be triggered with workflow_dispatch on a branch other than main"
        exit 1

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0
      with:
        versionSpec: '5.x'

    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v0
      with:
        useConfigFile: true    
    - name: Update CHANGELOG
      shell: pwsh
      run: |
        $version = "${{ steps.gitversion.outputs.semVer }}"
        $date = Get-Date -Format "yyyy-MM-dd"
        $changelogPath = ".\CHANGELOG.md"
        
        Write-Host "Updating CHANGELOG.md with version $version"
        $content = Get-Content $changelogPath -Raw
        $content = $content -replace '## \[Unreleased\]', "## [$version] - $date"
        Set-Content $changelogPath -Value $content -NoNewline
        
        Write-Host "CHANGELOG.md updated successfully"

    - name: Extract current version changelog
      id: changelog
      shell: pwsh
      run: |
        $version = "${{ steps.gitversion.outputs.semVer }}"
        $changelogPath = ".\CHANGELOG.md"
        
        $content = Get-Content $changelogPath -Raw
        
        # Extract content between current version and next version/end
        $pattern = "(?s)## \[$version\].*?\n(.*?)(?=\n## \[|$)"
        if ($content -match $pattern) {
          $changelogContent = $matches[1].Trim()
          
          # Escape for GitHub Actions output
          $changelogContent = $changelogContent -replace '%', '%25'
          $changelogContent = $changelogContent -replace '\n', '%0A'
          $changelogContent = $changelogContent -replace '\r', '%0D'
          
          # Use new GitHub Actions output syntax
          "CHANGELOG_CONTENT<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          $matches[1].Trim() | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          Write-Host "Extracted changelog for version $version"
        } else {
          Write-Host "Could not extract changelog content"
          "CHANGELOG_CONTENT=No changelog found for this version." | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        }

    - name: Commit CHANGELOG changes
      shell: pwsh
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add CHANGELOG.md
        git diff --staged --quiet || git commit -m "Update CHANGELOG for version ${{ steps.gitversion.outputs.semVer }} [skip ci] +semver:none"
        git push

    - name: publish
      shell: pwsh
      env:
        PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
      run: $env:PSGALLERY_API_KEY ; ./build.ps1 -Task Release -Bootstrap

    - name: Zip built module
      shell: pwsh
      run: |
        $moduleName = "OctopusDeploy"
        $version = "${{ steps.gitversion.outputs.semVer }}"
        $outputPath = ".\Output\$moduleName"
        $zipFileName = "${moduleName}-${version}.zip"
        
        if (Test-Path $outputPath) {
          Write-Host "Creating zip file: $zipFileName"
          Compress-Archive -Path "$outputPath\*" -DestinationPath ".\$zipFileName" -Force
          Write-Host "Zip file created successfully"
          
          # Verify zip was created
          if (Test-Path ".\$zipFileName") {
            $zipSize = (Get-Item ".\$zipFileName").Length
            Write-Host "Zip file size: $($zipSize / 1MB) MB"
          }
        } else {
          Write-Error "Output path not found: $outputPath"
          exit 1
        }
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.gitversion.outputs.semVer }}
        name: Release v${{ steps.gitversion.outputs.semVer }}
        body: |
          ## OctopusDeploy Module Release v${{ steps.gitversion.outputs.semVer }}
          
          ### Installation
          Install from PowerShell Gallery:
          ```powershell
          Install-Module -Name OctopusDeploy
          ```
          
          Or download the zip file and extract it to your PowerShell modules directory.
          
          ### Changes in this Release
          
          ${{ steps.changelog.outputs.CHANGELOG_CONTENT }}
          
          ---
          
          See full [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for all changes.
        files: |
          OctopusDeploy-${{ steps.gitversion.outputs.semVer }}.zip
        draft: false
        prerelease: false  # For mainline/main branch, never mark as prerelease
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}